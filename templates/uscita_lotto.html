{% extends "base.html" %}
{% block content %}

<h1 class="text-2xl font-bold mb-6 text-yellow-400">Scarico Magazzino (FIFO)</h1>

<div class="min-h-[60vh] flex items-center justify-center px-2">

    <form id="formScarico" method="POST"
        class="bg-white p-8 rounded-xl shadow-lg space-y-4 w-full max-w-md border border-gray-100">
        <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">Registra Scarico</h2>

        <div>
            <label class="font-semibold block mb-1 text-gray-700">Prodotto</label>
            <input type="text" id="prodottoInput" list="prodottiList" 
                placeholder="Scrivi il nome del prodotto..."
                class="w-full border border-gray-300 p-2.5 rounded-lg focus:ring-2 focus:ring-red-500 outline-none"
                required autocomplete="off">
            <datalist id="prodottiList">
                {% for p in prodotti %}
                <option value="{{ p[1] }}" data-id="{{ p[0] }}" data-max="{{ p[2] }}">
                    Disp: {{ p[2] }} | {{ p[3] or 'Nessuna marca' }}
                </option>
                {% endfor %}
            </datalist>
            <input type="hidden" id="prodotto_id" name="prodotto_id">
        </div>

        <div>
            <label class="font-semibold block mb-1 text-gray-700 text-sm">Marca (opzionale)</label>
            <input type="text" name="marca" 
                class="w-full border border-gray-200 p-2.5 rounded-lg bg-gray-50 text-gray-600 focus:ring-2 focus:ring-gray-300 outline-none"
                placeholder="Specifica marca se necessario">
        </div>

        <div>
            <label class="font-semibold block mb-1 text-gray-700">Quantità da scaricare</label>
            <input type="number" id="inputQuantita" name="quantita" min="1"
                class="w-full border border-gray-300 p-2.5 rounded-lg focus:ring-2 focus:ring-red-500 outline-none"
                placeholder="Inserisci quantità" required>
        </div>

        <button type="submit"
            class="bg-red-600 text-white px-4 py-3 rounded-lg font-bold hover:bg-red-700 transition w-full shadow-md shadow-red-100">
            Conferma Scarico
        </button>

        <a href="{{ url_for('lotti_view') }}"
            class="block text-center text-gray-700 mt-6 text-sm hover:text-gray-600 hover:underline">
            ← Torna alla lista lotti
        </a>
    </form>
</div>

<script>
    const prodottoInput = document.getElementById('prodottoInput');
    const hiddenIdInput = document.getElementById('prodotto_id');
    const datalist = document.getElementById('prodottiList');
    const inputQta = document.getElementById('inputQuantita');

    // Sincronizza l'ID quando l'utente seleziona o scrive un prodotto valido
    prodottoInput.addEventListener('input', function() {
        const val = this.value;
        const options = datalist.options;
        let foundId = "";
        
        for (let i = 0; i < options.length; i++) {
            if (options[i].value === val) {
                foundId = options[i].getAttribute('data-id');
                // Aggiorna anche il limite massimo per la quantità
                inputQta.setAttribute('data-max', options[i].getAttribute('data-max'));
                break;
            }
        }
        hiddenIdInput.value = foundId;
    });

    document.getElementById('formScarico').addEventListener('submit', function (e) {
        // Se l'ID è vuoto, significa che il prodotto scritto non è tra quelli suggeriti
        if (!hiddenIdInput.value) {
            e.preventDefault();
            alert("❌ Seleziona un prodotto valido dalla lista dei suggerimenti.");
            prodottoInput.focus();
            return;
        }

        const maxDisponibile = parseInt(inputQta.getAttribute('data-max'));
        const qtaRichiesta = parseInt(inputQta.value);

        if (qtaRichiesta > maxDisponibile) {
            e.preventDefault();
            alert("❌ Errore: Quantità non disponibile!\nMassimo disponibile: " + maxDisponibile);
            inputQta.classList.add('border-red-500', 'bg-red-50');
            inputQta.focus();
        }
    });

    inputQta.addEventListener('input', function () {
        this.classList.remove('border-red-500', 'bg-red-50');
    });
</script>

{% endblock %}