{% extends "base.html" %}
{% block content %}
<main class="max-w-7xl mx-auto mt-4 p-4">
    <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
        <div class="flex items-center gap-4">
            <a href="{{ url_for('visualizza_tutti_i_log') }}" 
               class="flex items-center justify-center w-10 h-10 bg-white border border-gray-200 text-gray-600 rounded-lg hover:bg-gray-50 hover:text-blue-600 transition shadow-sm"
               title="Torna ai Registri Sistema">
                <i class="fas fa-chevron-left"></i>
            </a>
            <div>
                <h1 class="text-3xl font-bold text-yellow-400 leading-tight">Archivio Riservato Admin</h1>
                <p class="text-xs text-gray-500 font-medium">Gestione documentale e registri</p>
            </div>
        </div>
        <span class="bg-red-600 text-white px-3 py-1 rounded text-xs font-black uppercase self-start md:self-center">
            Area Protetta
        </span>
    </div>

    <div id="tab-documenti" class="space-y-4 mb-6">
        <div
            class="flex flex-col md:flex-row gap-4 items-center justify-between bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <div class="relative flex-1 w-full">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-search text-gray-400"></i>
                </div>
                <input type="text" id="docSearch" placeholder="Cerca tra i registri salvati..."
                    class="w-full p-2.5 pl-10 rounded-lg border border-gray-300 focus:ring-2 focus:ring-yellow-400 focus:outline-none transition-all"
                    onkeyup="filterDocs()">
            </div>

            <button id="btn-mostra-form" onclick="toggleFormDocumenti()"
                class="bg-green-600 text-white px-6 py-2.5 rounded-lg font-bold shadow-md hover:bg-green-700 transition flex items-center gap-2 whitespace-nowrap w-full md:w-auto justify-center">
                <i class="fas fa-plus"></i> Crea Documento
            </button>
        </div>

        <div id="container-crea" class="hidden">
            <div class="bg-gray-100 p-6 rounded-xl shadow-lg border-t-4 border-blue-600 relative animate-fade-in">
                <button onclick="toggleFormDocumenti()" class="absolute top-4 right-4 text-gray-400 hover:text-red-500">
                    <i class="fas fa-times text-xl"></i>
                </button>

                <h2 class="text-lg font-bold mb-4 text-gray-800">ðŸ“¤ Carica nuovi registri (Accumulo file)</h2>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start">
                    <div>
                        <label class="block text-sm font-bold text-gray-700">Descrizione/Titolo Comune</label>
                        <input type="text" id="titolo_multiplo" required
                            class="w-full mt-1 border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500"
                            placeholder="Es: Documentazione 2026">
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700">Aggiungi File</label>
                        <input type="file" id="file_input_hidden" multiple class="hidden"
                            onchange="handleFileSelection(this)">
                        <button type="button" onclick="document.getElementById('file_input_hidden').click()"
                            class="w-full mt-1 bg-white border-2 border-dashed border-gray-300 p-2 rounded-lg text-gray-600 hover:border-blue-400 transition flex items-center justify-center gap-2">
                            <i class="fas fa-file-upload"></i> Scegli o trascina file
                        </button>

                        <div id="file-list-accumulated" class="mt-3 space-y-2 max-h-40 overflow-y-auto">
                        </div>
                    </div>

                    <div class="flex flex-col gap-2">
                        <label class="block text-sm font-bold text-gray-700 invisible">Azioni</label>
                        <button type="button" onclick="uploadTutto()" id="btn-invia-tutto"
                            class="bg-blue-600 text-white px-6 py-2.5 rounded-lg hover:bg-blue-700 transition font-bold shadow-md flex items-center justify-center gap-2">
                            <i class="fas fa-cloud-upload-alt"></i> Invia Tutti i File
                        </button>
                        <div id="progressContainer" class="hidden">
                            <div class="w-full bg-gray-300 rounded-full h-2 mt-2">
                                <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all"
                                    style="width: 0%"></div>
                            </div>
                            <p id="progressPercent" class="text-[10px] text-center font-bold text-blue-600 mt-1">0%</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed bottom-5 right-5 z-50 space-y-3"></div>

    {# Tabella Documenti #}
    <div class="bg-white rounded-xl shadow-2xl overflow-hidden border border-gray-200">
        <table class="w-full text-left" id="docTable">
            <thead class="bg-gray-800 text-white">
                <tr>
                    <th class="px-6 py-4 font-bold uppercase text-xs">Titolo Registro</th>
                    <th class="px-6 py-4 font-bold uppercase text-xs text-center">Download/Vedi</th>
                    <th class="px-6 py-4 font-bold uppercase text-xs">Data Caricamento</th>
                    <th class="px-6 py-4 font-bold uppercase text-xs text-center">Azioni</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% for doc in documenti %}
                <tr class="hover:bg-blue-50 transition-colors">
                    <td class="px-6 py-4">
                        <div class="font-bold text-gray-800">{{ doc[1] }}</div>
                        <div class="text-[10px] text-gray-500 font-mono">{{ doc[2] }}</div>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <a href="{{ url_for('static', filename='uploads/documenti/' + doc[2]) }}" target="_blank"
                            class="inline-flex items-center justify-center w-10 h-10 bg-gray-100 text-blue-600 rounded-full hover:bg-blue-600 hover:text-white transition shadow-sm">
                            <i class="fas fa-file-pdf"></i>
                        </a>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600 italic">
                        {{ doc[4].strftime('%d/%m/%Y %H:%M') if doc[4] else "â€”" }}
                    </td>
                    <td class="px-6 py-4 text-center">
                        <button onclick="eliminaDoc('{{ doc[0] }}')" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4" class="px-6 py-10 text-center text-gray-400 italic">Nessun documento in archivio.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</main>

<script>
    let fileBuffer = []; // Array per accumulare i file

    function toggleFormDocumenti() {
        const container = document.getElementById('container-crea');
        const btn = document.getElementById('btn-mostra-form');
        container.classList.toggle('hidden');
        if (!container.classList.contains('hidden')) {
            btn.innerHTML = '<i class="fas fa-minus"></i> Nascondi';
            btn.classList.replace('bg-green-600', 'bg-gray-500');
        } else {
            btn.innerHTML = '<i class="fas fa-plus"></i> Crea Documento';
            btn.classList.replace('bg-gray-500', 'bg-green-600');
        }
    }

    // Gestione selezione file (Accumulo)
    function handleFileSelection(input) {
        const files = Array.from(input.files);
        files.forEach(file => {
            // Evita duplicati basati sul nome e dimensione
            if (!fileBuffer.some(f => f.name === file.name && f.size === file.size)) {
                fileBuffer.push(file);
            }
        });
        input.value = ""; // Reset dell'input per permettere re-selezione
        aggiornaListaAnteprima();
    }

    function rimuoviDallaLista(index) {
        fileBuffer.splice(index, 1);
        aggiornaListaAnteprima();
    }

    function aggiornaListaAnteprima() {
        const container = document.getElementById('file-list-accumulated');
        container.innerHTML = '';
        fileBuffer.forEach((file, index) => {
            const div = document.createElement('div');
            div.className = "flex items-center justify-between bg-white p-2 rounded border border-blue-200 text-[11px] shadow-sm";
            div.innerHTML = `
                <span class="truncate pr-2"><i class="fas fa-file-alt text-blue-500"></i> ${file.name}</span>
                <button onclick="rimuoviDallaLista(${index})" class="text-red-500 hover:text-red-700">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(div);
        });
    }

    function uploadTutto() {
        const titolo = document.getElementById('titolo_multiplo').value;
        if (!titolo) return alert("Inserisci un titolo per i file");
        if (fileBuffer.length === 0) return alert("Seleziona almeno un file");

        const formData = new FormData();
        formData.append("titolo", titolo);
        fileBuffer.forEach(file => {
            formData.append("file_allegato", file);
        });

        const xhr = new XMLHttpRequest();
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        const btn = document.getElementById('btn-invia-tutto');

        progressContainer.classList.remove('hidden');
        btn.disabled = true;
        btn.classList.add('opacity-50');

        xhr.upload.addEventListener("progress", (e) => {
            if (e.lengthComputable) {
                const percent = Math.round((e.loaded / e.total) * 100);
                progressBar.style.width = percent + "%";
                progressPercent.innerText = percent + "%";
            }
        });

        xhr.onload = function () {
            if (xhr.status === 200) {
                location.reload();
            } else {
                alert("Errore nel caricamento");
                btn.disabled = false;
                progressContainer.classList.add('hidden');
            }
        };

        xhr.open("POST", "{{ url_for('documenti_view') }}", true);
        xhr.send(formData);
    }

    function filterDocs() {
        let input = document.getElementById("docSearch").value.toLowerCase();
        let rows = document.querySelectorAll("#docTable tbody tr");
        rows.forEach(row => {
            if (row.cells.length > 1) {
                row.style.display = row.innerText.toLowerCase().includes(input) ? "" : "none";
            }
        });
    }

    function eliminaDoc(id) {
    if (confirm("Vuoi davvero eliminare questo documento?")) {
        fetch(`/documenti/elimina/${id}`, { method: 'POST' })
        .then(response => {
            if (response.ok) {
                showToast("Documento eliminato con successo!");
                // Ricarichiamo la pagina dopo un piccolo delay per far vedere il toast
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast("Errore durante l'eliminazione", "error");
            }
        });
    }
}

    function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    
    // Colori in base al tipo
    const bgColor = type === 'success' ? 'bg-green-600' : 'bg-red-600';
    const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';

    toast.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-2xl flex items-center gap-3 transform transition-all duration-300 translate-y-10 opacity-0 animate-fade-in-up`;
    toast.innerHTML = `
        <i class="fas ${icon}"></i>
        <span class="font-bold text-sm">${message}</span>
    `;

    container.appendChild(toast);

    // Animazione entrata
    setTimeout(() => {
        toast.classList.remove('translate-y-10', 'opacity-0');
    }, 10);

    // Rimozione automatica dopo 3 secondi
    setTimeout(() => {
        toast.classList.add('translate-y-10', 'opacity-0');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}
</script>
<style>
    @keyframes fade-in-up {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}
.animate-fade-in-up {
    animation: fade-in-up 0.3s ease-out forwards;
}
</style>
{% endblock %}