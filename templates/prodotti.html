<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: "Inter", sans-serif;
      background-color: #eef2f7;
    }
  </style>
</head>

<body class="bg-blue-800">
  {% include "_header.html" %}

  <main class="max-w-7xl mx-auto mt-2">
    <h1 class="text-3xl font-bold text-yellow-400 mb-4">Prodotti Disponibili</h1>

    <!-- Campo di ricerca e pulsanti -->
    <div class="mb-4 flex flex-row items-center gap-3">
      <input id="searchInput" type="text" placeholder="üîç Cerca prodotti..."
        class="flex-1 min-w-0 border border-gray-300 rounded-lg p-3 text-sm sm:text-base" onkeyup="filterTable()" />

      {% if session.get("ruolo") in ["Amministratore", "Manager"] %}
      <a href="{{ url_for('nuovo_prodotto') }}"
        class="bg-green-600 text-white px-4 py-2 h-12 rounded-lg hover:bg-green-700 transition flex items-center gap-2 whitespace-nowrap shadow-md">
        <span class="text-xl">‚ûï</span>
        <span class="font-bold">Nuovo articolo</span>
      </a>
      {% endif %}

    </div>

    <!-- Filtro scadenza -->
    {% if session.get("ruolo") in ["Amministratore", "Manager"] %}
    <div class="mb-4 flex flex-wrap gap-3 items-center">
      <label class="flex items-center gap-2 text-white cursor-pointer">
        <input type="checkbox" id="filterScadenza" class="w-4 h-4" onchange="filterScadenza()" />
        <span class="text-sm sm:text-base">Mostra solo in scadenza</span>
      </label>
      <span class="text-sm text-red-300">(entro 30 giorni)</span>
    </div>
    {% endif %}

    <!-- Tabella prodotti -->
    <div class="relative overflow-x-auto bg-white shadow rounded-lg border border-gray-200">
      <table class="w-full text-sm text-left table-auto">
        <thead class="text-gray-700 bg-gray-100 border-b">
          <tr>
            <th class="px-6 py-3 font-semibold">ID</th>
            <th class="px-6 py-3 font-semibold">Nome</th>
            <th class="px-6 py-3 font-semibold">Marca</th>
            <th class="px-6 py-3 font-semibold">Categoria</th>
            <th class="px-6 py-3 font-semibold">Misura</th>

            {% if session.get("ruolo") in ["Amministratore", "Manager"] %}
            <th class="px-6 py-3 font-semibold">Quantit√†</th>

            <th class="px-6 py-3 font-semibold">Scadenza</th>
            {% endif %}

            <th class="px-6 py-3 font-semibold">Posizione</th>

            {% if session.get("ruolo") in ["Amministratore", "Manager"] %}
            <th class="px-6 py-3 font-semibold text-center">Note</th>
            {% endif %}
          </tr>
        </thead>

        <tbody class="text-gray-800 divide-y">
          {% for prodotto in prodotti %}
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-3">{{ prodotto[0] }}</td>
            <td class="px-6 py-3">
              {% if session.get("ruolo") in ["Amministratore", "Manager"] %}
              {# Solo Admin e Manager vedono il link al dettaglio #}
              <a href="{{ url_for('dettaglio_prodotto', prodotto_id=prodotto[0]) }}"
                class="font-bold text-blue-700 hover:underline decoration-2">
                {{ prodotto[1] }}
              </a>
              {% else %}
              {# Gli utenti semplici vedono solo il nome senza link #}
              <span class="font-bold text-gray-800">{{ prodotto[1] }}</span>
              {% endif %}
            </td>

            <td class="px-6 py-3 italic text-gray-600">{{ prodotto[2] or "‚Äî" }}</td>
            <td class="px-6 py-3">{{ prodotto[3] or "‚Äî" }}</td>
            <td class="px-6 py-3">{{ prodotto[4] or "‚Äî" }}</td> {% if session.get("ruolo") in ["Amministratore",
            "Manager"] %}
            <td class="px-6 py-3 font-bold {{ 'text-red-600' if prodotto[5]|int <= 0 else '' }}">
              {{ prodotto[5] }} </td>
            <td class="px-6 py-3">{{ prodotto[6] or "‚Äî" }}</td> {% endif %}

            <td class="px-6 py-3 flex items-center justify-between gap-2">
              <span>{{ prodotto[7] or "‚Äî" }}</span>
              <div class="flex gap-2">
                {% if session.get("ruolo") == "Amministratore" %}
                <a href="{{ url_for('modifica_prodotto', prodotto_id=prodotto[0]) }}"
                  class="bg-blue-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-blue-700 transition shadow-sm">
                  ‚úèÔ∏è
                </a>
                <button onclick="eliminaProdotto('{{ prodotto[0] }}', '{{ prodotto[1]|e }}')"
                  class="bg-red-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-red-700 transition shadow-sm">
                  üóëÔ∏è
                </button>
                {% endif %}
              </div>
            </td>

            {% if session.get("ruolo") in ["Amministratore", "Manager"] %}
            <td class="px-6 py-3 text-center">
              {% if prodotto[8] %} <button type="button"
                class="bg-yellow-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-yellow-600 btn-nota"
                data-nota="{{ prodotto[8] }}" data-id="{{ prodotto[0] }}">
                üìÑ Note
              </button>
              {% else %}
              <span class="text-gray-400">‚Äî</span>
              {% endif %}
            </td>
            {% endif %}

          </tr>
          {% else %}
          <tr>
            <td colspan="{% if session.get('ruolo') in ['Amministratore','Manager'] %}9{% else %}6{% endif %}"
              class="px-6 py-4 text-center text-gray-500">
              Nessun prodotto disponibile.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </main>

  <!-- MODAL NOTE -->
  <div id="noteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-lg max-w-lg w-full p-6">
      <h2 class="text-lg font-bold mb-3">üìÑ Note prodotto</h2>

      <textarea id="noteContent" class="w-full border border-gray-300 rounded p-2 h-32 text-sm"></textarea>

      <div class="mt-4 flex justify-end gap-2">
        <button onclick="closeNote()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
          Chiudi
        </button>
        <button onclick="saveNote()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
          Salva
        </button>
      </div>
    </div>
  </div>



  <script>
    let currentProdottoId = null;

function applyFilters() {
    const searchInput = document.getElementById("searchInput").value.toLowerCase();
    const checkboxScadenza = document.getElementById("filterScadenza");
    const isScadenzaChecked = checkboxScadenza ? checkboxScadenza.checked : false;

    const table = document.querySelector("table");
    const tbody = table.querySelector("tbody");
    const tr = tbody.getElementsByTagName("tr");
    
    let righeVisibili = 0;

    // Prepariamo le date
    const oggi = new Date();
    oggi.setHours(0, 0, 0, 0);
    const limite = new Date();
    limite.setDate(oggi.getDate() + 30);
    limite.setHours(23, 59, 59, 999);

    for (let i = 0; i < tr.length; i++) {
        // Salta la riga del messaggio "Nessun risultato" se gi√† presente
        if (tr[i].id === "no-results-row") continue;

        // 1. Filtro Testuale
        const testoRiga = tr[i].innerText.toLowerCase();
        const matchRicerca = testoRiga.includes(searchInput);

        // 2. Filtro Scadenza
        let matchScadenza = true;
        if (isScadenzaChecked) {
            const tdScadenza = tr[i].cells[6]; // Colonna Scadenza
            if (tdScadenza) {
                const dataTesto = tdScadenza.textContent.trim();
                if (dataTesto === "‚Äî" || dataTesto === "") {
                    matchScadenza = false;
                } else {
                    let parti = dataTesto.split(/[-/]/);
                    let dataOggetto = (parti[0].length === 4) 
                        ? new Date(parti[0], parti[1] - 1, parti[2]) 
                        : new Date(parti[2], parti[1] - 1, parti[0]);

                    matchScadenza = (!isNaN(dataOggetto.getTime()) && dataOggetto >= oggi && dataOggetto <= limite);
                }
            } else {
                matchScadenza = false; 
            }
        }

        // Mostra/Nascondi
        if (matchRicerca && matchScadenza) {
            tr[i].style.display = "";
            righeVisibili++;
        } else {
            tr[i].style.display = "none";
        }
    }

    // GESTIONE MESSAGGIO VUOTO
    let noResultsRow = document.getElementById("no-results-row");
    if (righeVisibili === 0) {
        if (!noResultsRow) {
            noResultsRow = document.createElement("tr");
            noResultsRow.id = "no-results-row";
            // Calcola dinamicamente il numero di colonne per il colspan
            const colCount = table.querySelector("thead tr").cells.length;
            noResultsRow.innerHTML = `
                <td colspan="${colCount}" class="px-6 py-10 text-center">
                    <div class="flex flex-col items-center justify-center text-gray-500">
                        <span class="text-4xl mb-2">üîç</span>
                        <p class="font-semibold text-lg">Nessun prodotto trovato</p>
                        <p class="text-sm">Prova a cambiare i filtri o la ricerca.</p>
                    </div>
                </td>`;
            tbody.appendChild(noResultsRow);
        } else {
            noResultsRow.style.display = "";
        }
    } else if (noResultsRow) {
        noResultsRow.style.display = "none";
    }
}
// Colleghiamo le funzioni agli eventi
function filterTable() { applyFilters(); }
function filterScadenza() { applyFilters(); }

// --- Gestione Note (Funzionante) ---
function showNote(note, prodottoId) {
    currentProdottoId = prodottoId;
    document.getElementById("noteContent").value = note || "";
    document.getElementById("noteModal").classList.remove("hidden");
    document.getElementById("noteModal").classList.add("flex");
}

function closeNote() {
    document.getElementById("noteModal").classList.add("hidden");
    document.getElementById("noteModal").classList.remove("flex");
    currentProdottoId = null;
}

document.addEventListener('DOMContentLoaded', function () {
    const bottoniNote = document.querySelectorAll('.btn-nota');
    bottoniNote.forEach(bottone => {
        bottone.addEventListener('click', function () {
            showNote(this.getAttribute('data-nota'), this.getAttribute('data-id'));
        });
    });
});

async function saveNote() {
    const note = document.getElementById("noteContent").value;
    if (!currentProdottoId) return;
    const response = await fetch(`/prodotti/note/${currentProdottoId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ note })
    });
    if (response.ok) { location.reload(); }
}

async function eliminaProdotto(id, nome) {
    if (confirm(`Eliminare definitivamente: ${nome}?`)) {
        const response = await fetch(`/prodotti/elimina/${id}`, { method: "POST" });
        if (response.ok) { location.reload(); }
    }
}

  </script>


</body>

</html>