{% extends "base.html" %}
{% block content %}

<div class="flex flex-col md:flex-row h-[80vh] bg-white rounded-xl shadow overflow-hidden">

    <!-- LISTA UTENTI (desktop) -->
    <aside class="hidden md:flex md:flex-col w-full md:w-1/3 border-r overflow-y-auto">
        <h3 class="p-4 font-bold border-b">Conversazioni</h3>
        {% for u in utenti %}
        <a href="{{ url_for('messaggi', destinatario_id=u[0]) }}" class="p-4 hover:bg-gray-100 cursor-pointer border-b">
            <div class="font-semibold">{{ u[1] }}</div>
            <div class="text-sm text-gray-500">Clicca per scrivere</div>
        </a>
        {% endfor %}
    </aside>

    <!-- CHAT -->
    <section class="flex flex-col flex-1 h-full">

        <!-- HEADER CHAT -->
        <div class="p-4 border-b bg-gray-100 font-semibold flex justify-between items-center">
            {% if destinatario is defined %}
            Chat con {{ destinatario[0] }}
            {% else %}
            Chat interna Magazzino
            {% endif %}

            {% if session.get("ruolo") == "Amministratore" %}
            <form method="POST" action="{{ url_for('broadcast') }}" class="ml-4 flex gap-2">
                <input name="contenuto" required placeholder="Broadcast ai Manager"
                    class="border rounded px-2 py-1 text-sm">
                <button class="bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700 text-sm">Invia</button>
            </form>
            {% endif %}
        </div>

        <!-- MESSAGGI -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50 flex flex-col-reverse">
            {% for m in messaggi %}
            {% set is_me = (m[3] == session.get("username")) %}
            <div class="flex {{ 'justify-end' if is_me else 'justify-start' }}">
                <div class="
                    max-w-[70%] px-4 py-2 rounded-lg text-sm
                    {{ 'bg-green-200 text-right' if is_me else 'bg-white border' }}
                ">
                    <div class="text-xs text-gray-500 mb-1">
                        {{ m[3] }} â†’ {{ m[4] }}
                    </div>
                    <div>{{ m[1] }}</div>
                    <div class="text-xs text-gray-400 mt-1">
                        {{ m[2].strftime("%d/%m %H:%M") }}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- INPUT -->
        <form method="POST" class="flex gap-2 p-4 border-t">
            <input name="contenuto" required
                placeholder="{% if destinatario is defined %}Scrivi a {{ destinatario[0] }}...{% else %}Scrivi un messaggio...{% endif %}"
                class="flex-1 border rounded-lg px-3 py-2">
            <button class="bg-green-600 text-white px-4 rounded-lg">Invia</button>
        </form>

    </section>

</div>

<!-- JS per scroll automatico in basso -->
<script>
    const chat = document.getElementById("chat-messages");
    if (chat) {
        chat.scrollTop = chat.scrollHeight;
    }
</script>

{% endblock %}