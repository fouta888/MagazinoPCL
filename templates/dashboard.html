{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold text-yellow-400 mb-6">Dashboard</h1>

<section class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-6 mt-4">

  <div
    class="bg-white p-3 rounded-xl shadow text-center h-24 flex flex-col justify-center border-b-4 border-indigo-500">
    <p class="text-xs text-gray-500 uppercase font-bold">Totale Prodotti</p>
    <p class="text-3xl font-bold text-indigo-600">{{ totale_prodotti }}</p>
  </div>

  <div class="bg-white p-3 rounded-xl shadow text-center h-24 flex flex-col justify-center border-b-4 border-green-500">
    <p class="text-xs text-gray-500 uppercase font-bold">Movimenti Oggi</p>
    <p class="text-3xl font-bold text-green-600">{{ movimenti_oggi }}</p>
  </div>

  {% if session.get("ruolo") == "Amministratore" %}
  <div class="bg-white p-3 rounded-xl shadow text-center h-24 flex flex-col justify-center border-b-4 border-blue-500">
    <p class="text-xs text-gray-500 uppercase font-bold">Utenti Attivi</p>
    <p class="text-3xl font-bold text-blue-600">{{ utenti_attivi }}</p>
  </div>
  {% else %}
  <div class="bg-white p-3 rounded-xl shadow text-center h-24 flex flex-col justify-center border-b-4 border-gray-300">
    <p class="text-xs text-gray-500 uppercase font-bold">Stato Sistema</p>
    <p class="text-sm font-bold text-gray-600 uppercase italic">Operativo</p>
  </div>
  {% endif %}

  {% if session.get("ruolo") in ["Amministratore", "Manager"] %}
  <button onclick="openDrawer('scadenzeDrawerTemplate')"
    class="bg-yellow-100 hover:bg-yellow-200 rounded-xl shadow p-3 h-24 flex flex-col items-center justify-center transition border-b-4 border-yellow-500">
    <span class="text-2xl">‚ö†Ô∏è</span>
    <p class="text-xs uppercase text-gray-600 font-bold">Scadenze</p>
    <p class="text-xl font-bold text-yellow-800">{{ lotti_in_scadenza|length }}</p>
  </button>
  {% endif %}

  {% if session.get("ruolo") in ["Amministratore", "Manager"] %}
  <button onclick="openDrawer('listaSpesaDrawerTemplate')"
    class="bg-orange-100 hover:bg-orange-200 rounded-xl shadow p-3 h-24 flex flex-col items-center justify-center transition border-b-4 border-orange-500">
    <span class="text-2xl">üõí</span>
    <p class="text-xs uppercase text-gray-600 font-bold">Lista Spesa</p>
    <p class="text-xl font-bold text-orange-700">{{ prodotti_sotto_soglia|length }}</p>
  </button>
  {% endif %}

</section>

<div id="drawerOverlay" onclick="closeDrawer()" class="fixed inset-0 bg-black/40 hidden z-40"></div>
<div id="drawer"
  class="fixed bottom-0 left-0 right-0 bg-white rounded-t-2xl shadow-xl transform translate-y-full transition-transform duration-300 z-50 max-h-[80vh] overflow-y-auto">
  <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white z-10">
    <h2 id="drawerTitle" class="font-bold text-lg"></h2>
    <button onclick="closeDrawer()" class="text-2xl p-2">&times;</button>
  </div>
  <div id="drawerContent" class="p-4"></div>
</div>

<template id="scadenzeDrawerTemplate">
  <ul class="space-y-3">
    {% for l in lotti_in_scadenza %}
    <li class="border-b pb-2">
      <div class="font-bold text-gray-800">üì¶ {{ l[1] }}</div>
      <div class="text-sm text-gray-600">Quantit√†: {{ l[2] }}</div>
      <div class="text-sm font-bold text-red-600">Scadenza: {{ l[3].strftime('%d/%m/%Y') if l[3] else 'N/D' }}</div>
    </li>
    {% else %}
    <li class="text-center py-4 text-gray-500 italic">Nessun lotto in scadenza.</li>
    {% endfor %}
  </ul>
</template>

<template id="listaSpesaDrawerTemplate">
  <div class="mb-4 flex justify-end">
    <button onclick="copyListaWhatsApp()"
      class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-green-700 flex items-center gap-2">
      <i class="fab fa-whatsapp"></i> Copia per WhatsApp
    </button>
  </div>
  <ul class="space-y-4" id="whatsapp-list-source">
    {% for p in prodotti_sotto_soglia %}
    <li class="border-b pb-2 flex justify-between items-center">
      <div>
        <strong class="prodotto-nome">{{ p[0] }}</strong><br>
        <span class="text-xs text-gray-400">Soglia min: {{ p[2] }}</span>
      </div>
      <div class="text-right font-bold text-lg text-orange-600">
        {{ p[1] }}
      </div>
    </li>
    {% else %}
    <li class="text-center py-10 text-green-600 font-bold italic">‚úÖ Scorte in regola!</li>
    {% endfor %}
  </ul>
</template>

<section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-4">
  <div class="bg-white rounded-xl shadow p-4 h-[400px]">
    <h3 class="font-semibold text-gray-700 mb-4 border-b pb-2">Prodotti per Categoria</h3>
    <canvas id="prodottiChart"></canvas>
  </div>
  <div class="bg-white rounded-xl shadow p-4 h-[400px]">
    <h3 class="font-semibold text-gray-700 mb-4 border-b pb-2">Movimenti Ultimi 7 Giorni</h3>
    <canvas id="movimentiChart"></canvas>
  </div>
</section>

<script id="dashboard-data" type="application/json">
{
  "categorie_labels": {{ categorie_labels | tojson }},
  "categorie_quantita": {{ categorie_quantita | tojson }},
  "movimenti_labels": {{ movimenti_trend.labels | tojson }},
  "movimenti_entrata": {{ movimenti_trend.in_entrata | tojson }},
  "movimenti_uscita": {{ movimenti_trend.in_uscita | tojson }}
}
</script>

<script>
  // GESTIONE DRAWER
  function openDrawer(templateId) {
    const template = document.getElementById(templateId);
    const content = document.getElementById("drawerContent");
    const drawer = document.getElementById("drawer");
    const overlay = document.getElementById("drawerOverlay");

    content.innerHTML = template.innerHTML;

    const titles = {
      'scadenzeDrawerTemplate': '‚ö†Ô∏è Lotti in Scadenza',
      'listaSpesaDrawerTemplate': 'üõí Lista della Spesa'
    };

    document.getElementById("drawerTitle").innerText = titles[templateId] || "Dettagli";
    overlay.classList.remove("hidden");
    drawer.classList.remove("translate-y-full");
  }

  function closeDrawer() {
    document.getElementById("drawer").classList.add("translate-y-full");
    document.getElementById("drawerOverlay").classList.add("hidden");
  }

  // WHATSAPP
  function copyListaWhatsApp() {
    let testo = "*üì¶ LISTA SPESA MAGAZZINO*\n";
    testo += "Data: " + new Date().toLocaleDateString('it-IT') + "\n\n";

    // Seleziona solo i nomi dei prodotti e le quantit√†
    const items = document.querySelectorAll("#drawerContent li");
    let hasItems = false;

    items.forEach(item => {
      const nome = item.querySelector('.prodotto-nome');
      const qta = item.querySelector('.text-right');
      if (nome && qta) {
        testo += "‚Ä¢ *" + nome.innerText.trim() + "* (Disp: " + qta.innerText.trim() + ")\n";
        hasItems = true;
      }
    });

    if (!hasItems) {
      alert("La lista √® vuota!");
      return;
    }

    navigator.clipboard.writeText(testo).then(() => {
      alert("‚úÖ Lista copiata! Incollala su WhatsApp.");
    });
  }

  // CHARTS
  // CHARTS
  document.addEventListener('DOMContentLoaded', function () {
    const dataElement = document.getElementById('dashboard-data');
    if (!dataElement) return;
    const data = JSON.parse(dataElement.textContent);

    // GRAFICO A TORTA (PIE CHART)
    new Chart(document.getElementById('prodottiChart'), {
      type: 'pie',
      data: {
        labels: data.categorie_labels,
        datasets: [{
          data: data.categorie_quantita,
          backgroundColor: [
            '#4f46e5', '#10b981', '#f59e0b', '#ef4444',
            '#8b5cf6', '#ec4899', '#06b6d4', '#f97316'
          ],
          borderWidth: 2,
          borderColor: '#ffffff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom', // Sposta la legenda sotto per dare pi√π spazio al cerchio
            labels: { boxWidth: 12, padding: 15 }
          }
        }
      }
    });

    // GRAFICO MOVIMENTI (LINEA) - Resta uguale
    new Chart(document.getElementById('movimentiChart'), {
      type: 'line',
      data: {
        labels: data.movimenti_labels,
        datasets: [
          { label: 'Entrate', data: data.movimenti_entrata, borderColor: '#22c55e', backgroundColor: '#22c55e', tension: 0.3 },
          { label: 'Uscite', data: data.movimenti_uscita, borderColor: '#ef4444', backgroundColor: '#ef4444', tension: 0.3 }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}