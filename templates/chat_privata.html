{% extends "base.html" %}

{% block footer_block %}
{% endblock %} {% block content %}

<div
    class="flex flex-col md:flex-row h-[calc(100vh-100px)] md:h-[85vh] bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">

    <aside class="hidden md:flex flex-col w-1/3 border-r bg-gray-50 h-full">
        <div class="p-4 font-bold border-b bg-white">
            <span><i class="fas fa-users text-green-600"></i> Collaboratori</span>
        </div>
        <div class="flex-1 overflow-y-auto">
            {% for u in utenti %}
            <a href="{{ url_for('chat_privata', dest_id=u[0]) }}"
                class="block p-4 hover:bg-white border-b {{ 'bg-green-100 border-l-4 border-green-600' if dest_id == u[0] else '' }}">
                <div class="font-semibold">{{ u[1] }}</div>
            </a>
            {% endfor %}
        </div>
    </aside>

    <main class="flex-1 flex flex-col bg-white h-full min-h-0">

        <div class="p-3 border-b flex items-center bg-gray-50 shrink-0">
            <a href="{{ url_for('messaggi') }}" class="md:hidden text-green-600 mr-4 p-2">
                <i class="fas fa-arrow-left text-xl"></i>
            </a>
            <div>
                <span class="font-bold text-gray-800 leading-none block">{{ destinatario[0] }}</span>
                <span class="text-[10px] text-green-500 font-bold uppercase">Chat Privata</span>
            </div>
        </div>

        <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4 bg-[#f0f2f5] flex flex-col">
            {% for m in messaggi %}
            {# Confronto semplice: il mittente (m[2]) è l'utente in sessione? #}
            {% set mittente_nome = m[2]|string|trim %}
            {% set io = session.get("username")|string|trim %}
            {% set is_me = (mittente_nome == io) %}

            <div class="flex w-full {{ 'justify-end' if is_me else 'justify-start' }}">
                <div
                    class="max-w-[85%] rounded-2xl px-4 py-2 shadow-sm
                {{ 'bg-green-600 text-white rounded-tr-none' if is_me else 'bg-gray-500 text-white border rounded-tl-none' }}">

                    <div class="text-[10px] mb-1 opacity-70 font-bold uppercase">
                        {{ m[2] }} • {{ m[1].strftime("%H:%M") }}
                    </div>

                    <div class="text-sm break-words">{{ m[0] }}</div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="p-3 bg-white border-t shrink-0 sticky bottom-0">
            <form method="POST" class="flex gap-2">
                <input name="contenuto" required autocomplete="off" placeholder="Scrivi messaggio..."
                    class="flex-1 border border-gray-300 rounded-full px-4 py-2 text-base focus:outline-none focus:ring-2 focus:ring-green-500 shadow-inner">
                <button type="submit"
                    class="bg-green-600 text-white w-10 h-10 rounded-full flex items-center justify-center shrink-0 shadow-lg">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </main>
</div>

<script>
    const chatBox = document.getElementById("chat-box");
    function scrollBottom() {
        if (chatBox) { chatBox.scrollTop = chatBox.scrollHeight; }
    }
    window.onload = scrollBottom;
</script>

{% endblock %}