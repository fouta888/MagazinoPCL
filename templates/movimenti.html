{% extends "base.html" %}

{% block title %}Storico Movimenti{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-6 text-yellow-400">Storico Movimenti (FIFO)</h1>

<!-- Filtri ricerca -->
<div class="mb-4 flex flex-col sm:flex-row items-center gap-3">
  <input id="searchInput" type="text" placeholder="ðŸ” Cerca per prodotto, tipo, lotto..."
    class="flex-1 border border-gray-300 rounded-lg p-2" onkeyup="filterTable()" />
  <!-- Toggle solo uscita FIFO -->
  <button id="fifoToggle" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
    Mostra solo uscita (FIFO)
  </button>
</div>

<div class="overflow-x-auto bg-white shadow rounded-lg border border-gray-200">
  <table id="movimentiTable" class="w-full text-sm text-left table-auto">
    <thead class="bg-gray-100 border-b text-gray-700">
      <tr>
        <th class="px-4 py-2">ID</th>
        <th class="px-4 py-2">Data</th>
        <th class="px-4 py-2">Tipo</th>
        <th class="px-4 py-2">Prodotto</th>
        <th class="px-4 py-2">QuantitÃ </th>
        <th class="px-4 py-2">Scadenza</th>
        <th class="px-4 py-2">Posizione</th>
        <th class="px-4 py-2">Note</th>
      </tr>
    </thead>
    <tbody class="divide-y text-gray-800">
      {% for m in movimenti %}
      <tr data-tipo="{{ m[2] }}"
        class="{{ 'bg-green-50/30' if m[2] == 'entrata' else 'bg-red-50/30' }} hover:bg-gray-100 transition">
        <td class="px-4 py-2 font-mono text-xs text-gray-500">{{ m[0] }}</td>

        <td class="px-4 py-2 whitespace-nowrap">
          {% if m[1] is string %}
          {{ m[1][:16] }}
          {% else %}
          {{ m[1].strftime('%d/%m/%Y %H:%M') }}
          {% endif %}
        </td>

        <td class="px-4 py-2">
          {% if m[2] == 'entrata' %}
          <span class="text-green-600 font-bold"><i class="fas fa-arrow-down fa-xs"></i> Entrata</span>
          {% else %}
          <span class="text-red-600 font-bold"><i class="fas fa-arrow-up fa-xs"></i> Uscita</span>
          {% endif %}
        </td>

        <td class="px-4 py-2 font-semibold">{{ m[4] }}</td>
        <td class="px-4 py-2 font-bold">{{ m[3] }}</td>

        <td class="px-4 py-2 text-gray-600">
          {% if m[5] %}
          {% if m[5] is string %}
          {{ m[5] }}
          {% else %}
          {{ m[5].strftime('%d/%m/%Y') }}
          {% endif %}
          {% else %}
          â€”
          {% endif %}
        </td>

        <td class="px-4 py-2">{{ m[6] }}</td>
        <td class="px-4 py-2 italic text-gray-500 text-xs">{{ m[7] if m[7] else "â€”" }}</td>
      </tr>
      {% else %}
      <tr>
        <td colspan="8" class="text-center py-8 text-gray-400 italic">Nessun movimento registrato.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Filtro JavaScript -->
<script>
  const searchInput = document.getElementById("searchInput");
  const fifoToggle = document.getElementById("fifoToggle");
  let fifoActive = false;

  function filterTable() {
    const searchText = searchInput.value.toLowerCase();
    const rows = document.querySelectorAll("#movimentiTable tbody tr");

    rows.forEach(row => {
      const tipo = row.dataset.tipo;
      const cells = Array.from(row.querySelectorAll("td"));

      // Verifica se la riga contiene il testo cercato
      const matchesSearch = cells.some(td => td.textContent.toLowerCase().includes(searchText));

      // Verifica se la riga rispetta il filtro FIFO (solo uscite)
      const matchesFIFO = !fifoActive || tipo === "uscita";

      // La riga appare solo se soddisfa ENTRAMBI i criteri
      if (matchesSearch && matchesFIFO) {
        row.style.display = "";
      } else {
        row.style.display = "none";
      }
    });
  }

  // Listener per la ricerca testuale
  searchInput.addEventListener("keyup", filterTable);

  // Listener per il bottone FIFO
  fifoToggle.addEventListener("click", function () {
    fifoActive = !fifoActive;

    // Cambia stile e testo al bottone
    if (fifoActive) {
      this.textContent = "Mostra tutti i movimenti";
      this.classList.replace('bg-blue-600', 'bg-gray-600');
    } else {
      this.textContent = "Mostra solo uscita (FIFO)";
      this.classList.replace('bg-gray-600', 'bg-blue-600');
    }

    filterTable(); // Riesegue il filtro globale
  });
</script>

{% endblock %}